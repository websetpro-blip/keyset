# ПЕРЕДЕЛАН UI ПО АРХИТЕКТУРЕ KEY COLLECTOR

**Дата:** 26.10.2025
**Файл:** `c:\AI\yandex\keyset\app\tabs\parsing_tab.py`
**Статус:** ✅ ВЫПОЛНЕНО

---

## 🎯 ЗАДАЧА

Переделать UI парсинга согласно **реальной архитектуре Key Collector**:
- Левая колонка (5-10%) - управление выбором строк
- Центральная таблица (80%) - ОСНОВНАЯ, широкая таблица с фразами
- Правая колонка (10%) - группы фраз
- TOP PANEL - кнопки функций вверху
- BOTTOM JOURNAL - журнал логов внизу

---

## ✅ ВЫПОЛНЕНО

### 1. Структура UI (3 колонки + панели)

**Файл:** [parsing_tab.py:333-533](c:\AI\yandex\keyset\app\tabs\parsing_tab.py#L333-L533)

```
┌──────────────────────────────────────────────────────────────┐
│ TOP PANEL: ➕ ❌ | 📊 📦 💰 | 🗑️ 💾        [🟢 Готово]     │
├────────────┬─────────────────────────────────┬───────────────┤
│ ЛЕВАЯ 5%   │     ЦЕНТРАЛЬНАЯ 80%             │  ПРАВАЯ 10%   │
│            │                                 │               │
│ ✓ Выбрать  │ [🚀 Запуск]  [⏹ Стоп] [████]   │ Группы фраз   │
│ ✗ Снять    │                                 │               │
│ 🔄 Инверт   │ № │ Фраза        │ Част. │ Ст. │ ✓ Все фразы   │
│            │ 1 │ ремонт кв    │ 27892 │ ✓  │ ✓ Группа 1    │
│ Настройки: │ 2 │ купить тел   │ 25938 │ ✓  │ ✗ Группа 2    │
│ Профили    │ 3 │ смета рем    │ 20423 │ ✓  │               │
│ Режимы     │ ...                            │ ➕ Новая      │
│ Регионы    │                                 │               │
│            │ [Добавить фразы]                │               │
│            │ [текстовое поле 80px]           │               │
└────────────┴─────────────────────────────────┴───────────────┘
│ JOURNAL: 📋 Журнал активности (логи)                        │
└──────────────────────────────────────────────────────────────┘
```

### 2. TOP PANEL - кнопки функций

**Кнопки:**
- ➕ **Добавить** - добавить фразы из поля ввода в таблицу
- ❌ **Удалить** - удалить выбранные строки
- 📊 **Частотка** - запустить парсинг WS
- 📦 **Пакет** - пакетный парсинг (заглушка)
- 💰 **Прогноз** - прогноз бюджета (заглушка)
- 🗑️ **Очистить** - очистить всю таблицу
- 💾 **Экспорт** - экспорт в CSV
- **🟢 Готово** - статус справа

### 3. ЛЕВАЯ КОЛОНКА (5-10%)

**Компоненты:**

**A. Кнопки управления выбором:**
- ✓ **Выбрать все** - выделить все строки таблицы
- ✗ **Снять выбор** - снять выделение
- 🔄 **Инвертировать** - инвертировать выбор

**B. Настройки (компактно):**
- **Профили** - список профилей с чекбоксами (100px высота)
- **Режимы** - WS, "WS", !WS чекбоксы
- **Регионы** - дерево регионов (80px высота)

### 4. ЦЕНТРАЛЬНАЯ КОЛОНКА (80%) - ОСНОВНАЯ

**Кнопки управления парсингом:**
- 🚀 **Запустить парсинг** - запуск многопоточного парсинга
- ⏹ **Стоп** - остановка
- **[████]** - прогресс-бар

**ОСНОВНАЯ ТАБЛИЦА (4 колонки):**

| № | Фраза | Частотность | Статус |
|---|-------|-------------|--------|
| 40px | **500px** ← ШИРОКАЯ | 120px | 80px |

**Важно:** Колонка "Фраза" - самая широкая (500px), основная!

**Настройки таблицы:**
- `setSelectionBehavior(QAbstractItemView.SelectRows)` - выбор строк
- `setSelectionMode(QAbstractItemView.MultiSelection)` - множественный выбор
- `setMinimumHeight(400)` - минимум 400px высоты

**Поле ввода фраз:**
- Компактное (80px высота)
- Под таблицей
- Placeholder: "Введите фразы (каждая с новой строки)"

### 5. ПРАВАЯ КОЛОНКА (10%)

**Группы фраз:**
- Список групп (QListWidget)
- ✓ Все фразы
- ✓ Группа 1
- ✗ Группа 2
- ➕ **Новая** - создать группу (заглушка)

### 6. BOTTOM JOURNAL

**Журнал активности:**
- Терминальный стиль (черный фон, зеленый текст)
- Максимум 150px высоты
- Моноширинный шрифт (Consolas)
- Кнопка "Очистить журнал"

---

## 🔧 ФУНКЦИИ

### Управление выбором строк (левая панель)

**Файл:** [parsing_tab.py:773-791](c:\AI\yandex\keyset\app\tabs\parsing_tab.py#L773-L791)

```python
def _select_all_rows(self):
    """Выбрать все строки в таблице"""
    self.table.selectAll()
    self._append_log(f"✓ Выбрано строк: {self.table.rowCount()}")

def _deselect_all_rows(self):
    """Снять выбор со всех строк"""
    self.table.clearSelection()
    self._append_log("✗ Выбор снят")

def _invert_selection(self):
    """Инвертировать выбор строк"""
    for row in range(self.table.rowCount()):
        if self.table.item(row, 0).isSelected():
            self.table.item(row, 0).setSelected(False)
        else:
            self.table.selectRow(row)
    selected_count = len(self.table.selectionModel().selectedRows())
    self._append_log(f"🔄 Выбор инвертирован ({selected_count} строк)")
```

### TOP PANEL функции

**Файл:** [parsing_tab.py:797-859](c:\AI\yandex\keyset\app\tabs\parsing_tab.py#L797-L859)

```python
def _on_add_phrases(self):
    """Добавить фразы из поля ввода в таблицу"""
    # Читает текст из self.phrases_edit
    # Добавляет каждую фразу как новую строку в таблицу
    # Очищает поле ввода

def _on_delete_phrases(self):
    """Удалить выбранные фразы из таблицы"""
    # Получает выбранные строки
    # Удаляет их в обратном порядке
    # Перенумеровывает оставшиеся строки

def _on_clear_results(self):
    """Очистить все результаты из таблицы"""
    # Удаляет все строки: self.table.setRowCount(0)

def _on_batch_parsing(self):
    """Пакетный парсинг - заглушка"""

def _on_forecast(self):
    """Прогноз бюджета - заглушка"""

def _on_new_group(self):
    """Создать новую группу - заглушка"""
```

### Обновлен парсинг

**Изменено:** Фразы берутся из таблицы, а не из текстового поля!

**Файл:** [parsing_tab.py:864-877](c:\AI\yandex\keyset\app\tabs\parsing_tab.py#L864-L877)

```python
def _on_run_clicked(self):
    """Запуск многопоточного парсинга"""
    # Получаем фразы из таблицы (колонка 1 - "Фраза")
    phrases = []
    for row in range(self.table.rowCount()):
        phrase_item = self.table.item(row, 1)
        if phrase_item:
            phrase = phrase_item.text().strip()
            if phrase:
                phrases.append(phrase)
```

### Обновлен вывод результатов

**Изменено:** Результаты обновляют существующие строки в таблице!

**Файл:** [parsing_tab.py:711-749](c:\AI\yandex\keyset\app\tabs\parsing_tab.py#L711-L749)

```python
def _populate_results(self, rows: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """Обновить результаты в таблице (заполнить частотность и статус)."""

    # Создаём словарь результатов по фразам
    results_map = {}
    for record in rows:
        phrase = str(record.get("phrase", ""))
        ws_value = record.get("ws", "")
        status_value = record.get("status", "")
        results_map[phrase] = {
            "ws": str(ws_value) if ws_value is not None else "",
            "status": str(status_value) if status_value else "OK"
        }

    # Обновляем существующие строки в таблице
    for row in range(self.table.rowCount()):
        phrase_item = self.table.item(row, 1)
        if phrase_item:
            phrase = phrase_item.text()

            # Если для этой фразы есть результат - обновляем
            if phrase in results_map:
                result = results_map[phrase]

                # Колонка 2: Частотность
                self.table.setItem(row, 2, QTableWidgetItem(result["ws"]))

                # Колонка 3: Статус
                status_text = "✓" if result["status"] == "OK" and result["ws"] else "⏱"
                self.table.setItem(row, 3, QTableWidgetItem(status_text))
```

---

## 📐 ПРОПОРЦИИ

**QSplitter размеры:**
```python
splitter_main.setSizes([100, 800, 120])
```

| Колонка | Ширина | % |
|---------|--------|---|
| Левая | 100px | ~8% |
| Центр | 800px | ~80% |
| Правая | 120px | ~12% |

**Итого:** ~1000px

---

## 🎨 WORKFLOW (как в Key Collector)

### 1. Добавление фраз:
1. Ввести фразы в поле под таблицей (каждая с новой строки)
2. Нажать **➕ Добавить**
3. Фразы появляются в таблице с номерами

### 2. Парсинг:
1. Выбрать профили в левой панели
2. Нажать **📊 Частотка** (или 🚀 Запустить парсинг)
3. Парсер заполняет колонку "Частотность" для каждой строки
4. Статус показывает ✓ (успех) или ⏱ (таймаут)

### 3. Работа со строками:
- **Выбрать все** → Ctrl+A аналог
- **Снять выбор** → очистка выделения
- **Инвертировать** → выбрать невыбранные
- **❌ Удалить** → удалить выбранные строки

### 4. Экспорт:
1. Нажать **💾 Экспорт**
2. CSV с 2 колонками: Фраза | Частотность
3. TAB разделитель, UTF-8-sig

---

## ✅ ЧЕК-ЛИСТ ВЫПОЛНЕНИЯ

### Структура UI:
- [x] TOP PANEL с кнопками
- [x] Левая колонка (5-10%) - управление + настройки
- [x] Центральная таблица (80%) - ОСНОВНАЯ
- [x] Правая колонка (10%) - группы
- [x] BOTTOM JOURNAL - логи

### Левая колонка:
- [x] Кнопка "✓ Выбрать все"
- [x] Кнопка "✗ Снять выбор"
- [x] Кнопка "🔄 Инвертировать"
- [x] Компактные настройки (профили, режимы, регионы)

### Центральная таблица:
- [x] 4 колонки: №, Фраза, Частотность, Статус
- [x] Колонка "Фраза" самая широкая (500px)
- [x] MultiSelection режим
- [x] SelectRows поведение
- [x] Минимальная высота 400px

### TOP PANEL кнопки:
- [x] ➕ Добавить
- [x] ❌ Удалить
- [x] 📊 Частотка
- [x] 📦 Пакет
- [x] 💰 Прогноз
- [x] 🗑️ Очистить
- [x] 💾 Экспорт
- [x] Статус справа

### Функции:
- [x] `_select_all_rows()`
- [x] `_deselect_all_rows()`
- [x] `_invert_selection()`
- [x] `_on_add_phrases()`
- [x] `_on_delete_phrases()`
- [x] `_on_clear_results()`
- [x] `_on_batch_parsing()` (заглушка)
- [x] `_on_forecast()` (заглушка)
- [x] `_on_new_group()` (заглушка)

### Парсинг:
- [x] Фразы берутся из таблицы (не из текстового поля)
- [x] Результаты обновляют существующие строки
- [x] Частотность заполняется в колонку 2
- [x] Статус заполняется в колонку 3

---

## 🚀 КАК ИСПОЛЬЗОВАТЬ НОВЫЙ UI

### Быстрый старт:

1. **Добавить фразы:**
   - Ввести в поле под таблицей: "ремонт квартиры\nкупить телефон\nсмета"
   - Нажать **➕ Добавить**
   - Фразы появятся в таблице

2. **Настроить парсинг:**
   - В левой панели выбрать профили (чекбоксы)
   - Отметить режимы: WS ✓
   - Выбрать регион: 225 (Россия)

3. **Запустить:**
   - Нажать **📊 Частотка** или **🚀 Запустить парсинг**
   - Наблюдать в журнале прогресс
   - Результаты появятся в колонке "Частотность"

4. **Управлять:**
   - Выбрать строки → **✓ Выбрать все**
   - Удалить ненужные → **❌ Удалить**
   - Очистить всё → **🗑️ Очистить**

5. **Экспорт:**
   - Нажать **💾 Экспорт**
   - Сохранить CSV с результатами

---

## 📊 ДО vs ПОСЛЕ

### ДО (старый UI):
```
┌────────────────────────────────┐
│ Профили | Режимы | Регионы     │  ← Всё вверху
├────────────────────────────────┤
│ [Текстовое поле для фраз 200px]│
│                                │
│ [Кнопки управления]            │
├────────────────────────────────┤
│ Таблица результатов (8 колонок)│
├────────────────────────────────┤
│ Журнал 200px                   │
└────────────────────────────────┘
```

### ПОСЛЕ (новый UI - Key Collector):
```
┌──────────────────────────────────────────────┐
│ [Кнопки вверху]              [Статус]       │
├──────┬────────────────────────┬──────────────┤
│ 5%   │         80%            │     10%      │
│      │                        │              │
│ Упр. │   БОЛЬШАЯ ТАБЛИЦА      │   Группы    │
│      │   (Фраза 500px!)       │              │
│ Наст.│                        │              │
├──────┴────────────────────────┴──────────────┤
│ Журнал 150px                                 │
└──────────────────────────────────────────────┘
```

**Преимущества:**
- ✅ Больше места для фраз (таблица 80% ширины)
- ✅ Удобное управление строками (выбор, удаление)
- ✅ Компактные настройки слева
- ✅ Визуально понятнее (как в Key Collector)
- ✅ Быстрый доступ к функциям (TOP PANEL)

---

## 📝 ФАЙЛЫ ИЗМЕНЕНЫ

**Основной файл:**
- `c:\AI\yandex\keyset\app\tabs\parsing_tab.py`
  - Метод `_init_ui()` полностью переписан (строки 333-533)
  - Метод `_wire_signals()` обновлен (строки 535-562)
  - Добавлены функции управления (строки 773-859)
  - Обновлен `_on_run_clicked()` (строки 864-877)
  - Обновлен `_populate_results()` (строки 711-749)

**Импорты:**
- Добавлен `QAbstractItemView` для настроек таблицы

---

**Автор:** Claude (AI Assistant)
**Encoding:** UTF-8
**Проверено:** Синтаксис валиден ✓
**Архитектура:** Key Collector style ✓
