# Исправления пакетного сбора фраз

## Что исправлено (2025-10-26)

### 1. Переделан механизм выбора регионов

**Было:** Плоский список чекбоксов с отступами по глубине

**Стало:** Раскрывающееся дерево регионов (QTreeWidget) как на https://panel.aitibot.ru/aiti-collector

#### Изменения:
- Заменён `QScrollArea` + список `QCheckBox` на `QTreeWidget`
- Регионы теперь отображаются в виде дерева с возможностью раскрытия/сворачивания
- Сохранена точная логика выбора из AitiCollector:
  - При выборе региона снимаются чекбоксы со всех потомков
  - При выборе региона снимаются чекбоксы со всех предков
  - Поиск фильтрует дерево рекурсивно

### 2. Удалён блок "Устройства"

**Было:** В левой панели был блок выбора устройств:
- Все устройства
- Десктопы
- Смартфоны
- Планшеты

**Стало:** Блок полностью удалён из интерфейса и из структуры настроек

#### Изменённые файлы:
- `app/dialogs/batch_collect_dialog.py` - удалён UI блок и поле `devices` из настроек
- `app/tabs/parsing_tab.py` - удалена обработка `devices` в `_on_batch_collect_requested()`
- `test_batch_dialog.py` - обновлён вывод тестовых результатов

### 3. Улучшена производительность

- Добавлена блокировка сигналов при массовых операциях с деревом (`blockSignals()`)
- Предотвращена рекурсия при изменении чекбоксов
- Оптимизирована фильтрация дерева

## Код изменений

### RegionSelector - основные методы

```python
def _render_regions(self):
    """Отрисовка дерева регионов"""
    # Создаём QTreeWidget вместо списка чекбоксов
    def create_tree_item(node: RegionNode, parent_item: Optional[QTreeWidgetItem] = None):
        # Рекурсивное создание дерева
        ...

def _on_tree_item_changed(self, item, column):
    """Обработка изменения чекбокса в дереве"""
    # Блокируем сигналы
    self.tree_widget.blockSignals(True)

    # Снимаем чекбоксы с потомков и предков
    self._uncheck_descendants(item)
    self._uncheck_ancestors(item)

    self.tree_widget.blockSignals(False)
```

## Тестирование

Запуск теста:
```bash
cd c:\AI\yandex\keyset
python test_batch_dialog.py
```

Ожидаемый результат:
- Диалог открывается с деревом регионов
- Можно раскрывать/скрывать ветки
- При выборе региона снимаются чекбоксы с потомков и предков
- Поиск корректно фильтрует дерево
- Блок "Устройства" отсутствует

## Структура диалога после исправлений

```
┌─────────────────────────────────────────────────────────┐
│  Пакетный сбор фраз из Yandex.Wordstat                  │
├───────────────────┬─────────────────────────────────────┤
│ ЛЕВАЯ ПАНЕЛЬ      │ ПРАВАЯ ПАНЕЛЬ                       │
│                   │                                     │
│ Регионы           │ Режим добавления фраз               │
│ ┌───────────────┐ │ ○ в активную группу                 │
│ │ 🔍 Поиск...   │ │ ● распределить по группам           │
│ └───────────────┘ │                                     │
│ ☑ Все регионы     │ Опции                               │
│                   │ ☑ Пропускать существующие           │
│ ▼ Россия (225)    │ ☐ Интегрировать минус-слова         │
│   ▸ Центр (3)     │ ☐ Добавлять "+" оператор            │
│   ▸ Северо-Запад  │                                     │
│   ▸ Поволжье      │ Список фраз:                        │
│   ...             │ ┌─────────────────────────────────┐ │
│                   │ │ купить телефон                  │ │
│ Порог показов     │ │ ремонт квартиры                 │ │
│ ┌───────────────┐ │ │ ...                             │ │
│ │ 20 показов    │ │ └─────────────────────────────────┘ │
│ └───────────────┘ │                                     │
│                   │ [▶ Начать сбор] [📂] [🗑]           │
└───────────────────┴─────────────────────────────────────┘
```

## Итого

✅ Логика выбора регионов работает **точно как на panel.aitibot.ru/aiti-collector**
✅ Блок "Устройства" полностью удалён
✅ UI стал более компактным и удобным
✅ Код оптимизирован и протестирован

---

**Дата:** 2025-10-26
**Исправлено:** Claude Code
